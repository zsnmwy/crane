<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.102.3"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/main-docsy/favicons/favicon.ico><link rel=apple-touch-icon href=/main-docsy/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/main-docsy/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/main-docsy/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/main-docsy/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/main-docsy/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/main-docsy/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/main-docsy/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/main-docsy/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/main-docsy/favicons/android-192x192.png sizes=192x192><title>Pod Sorting And Precise Execution For Crane Agent | Crane</title><meta name=description content="The proposal enriches the sorting strategy of the crane agent and perfects the general sorting. In addition, a framework of precise operation …"><meta property="og:title" content="Pod Sorting And Precise Execution For Crane Agent"><meta property="og:description" content="The proposal enriches the sorting strategy of the crane agent and perfects the general sorting. In addition, a framework of precise operation (throttle/eviction) is implemented. When performing throttle, eviction and other operations, the precise operation logic of operating to the water level specified by the user, i.e. stopping, avoids excessive operation of low optimal pod;
Specifically:
Enriches the sorting strategy of crane agent, and perfects the general sorting and CPU dimension sorting with CPU usage as the main reference;"><meta property="og:type" content="article"><meta property="og:url" content="https://docs.gocrane.io/main-docsy/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-09-18T22:20:58+08:00"><meta property="og:site_name" content="Crane"><meta itemprop=name content="Pod Sorting And Precise Execution For Crane Agent"><meta itemprop=description content="The proposal enriches the sorting strategy of the crane agent and perfects the general sorting. In addition, a framework of precise operation (throttle/eviction) is implemented. When performing throttle, eviction and other operations, the precise operation logic of operating to the water level specified by the user, i.e. stopping, avoids excessive operation of low optimal pod;
Specifically:
Enriches the sorting strategy of crane agent, and perfects the general sorting and CPU dimension sorting with CPU usage as the main reference;"><meta itemprop=dateModified content="2022-09-18T22:20:58+08:00"><meta itemprop=wordCount content="2542"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Pod Sorting And Precise Execution For Crane Agent"><meta name=twitter:description content="The proposal enriches the sorting strategy of the crane agent and perfects the general sorting. In addition, a framework of precise operation (throttle/eviction) is implemented. When performing throttle, eviction and other operations, the precise operation logic of operating to the water level specified by the user, i.e. stopping, avoids excessive operation of low optimal pod;
Specifically:
Enriches the sorting strategy of crane agent, and perfects the general sorting and CPU dimension sorting with CPU usage as the main reference;"><link rel=preload href=/main-docsy/scss/main.min.f4870c69a3526683406b314140cdd0fe00001c7dfe1b1b9bd6bd473abba6c143.css as=style><link href=/main-docsy/scss/main.min.f4870c69a3526683406b314140cdd0fe00001c7dfe1b1b9bd6bd473abba6c143.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/main-docsy/><span class=navbar-logo><svg id="图层_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="306" height="186" viewBox="144.139 425.446 306 186" enable-background="new 144.139 425.446 306 186"><path fill="#58bda6" d="M267.919 572.702c-.372 5.728-4.972 10.091-10.27 9.743l-40.779-2.65c-5.3-.347-9.293-5.269-8.923-10.991l2.974-45.702c.373-5.728 4.973-10.088 10.271-9.743l40.78 2.652c5.299.345 9.293 5.267 8.921 10.99L267.919 572.702z"/><path fill="#ee7300" d="M355.802 528.969c-28.058-24.713-63.021-62.657-91.196-87.232-1.938-1.69-5.604-3.409-7.457-2.647-1.938.795-3.404 4.46-3.778 7.058-1.761 12.192-2.91 28.237-4.656 40.433-.437 3.041-1.971 6.067-3.571 8.762-2.041 3.435-.873 12.792 2.958 15.723 3.085 2.357 4.303 5.096 1.854 7.834-1.351 1.512-4.525 1.391-6.992 2.032 2.374 2.482 5.765 2.633 9.24-.084 3.808-2.979 2.631-7.084-4.054-14.46 4.628-3.659 5.886-7.839 2.424-13.33-1.104-1.75-.191-4.886.068-7.356 1.027-9.761 2.094-23.278 3.315-33.019.292-2.324 1.237-4.564 2.349-8.479 26.078 34.224 56.794 78.868 82.623 112.767.93-6.764-.387-17.9-.708-23.131-.193-3.154-5.785-8.536-7.861-11.352-3.039-4.109-6.746-7.742-9.644-11.94-.76-1.101-.824-2.206.128-3.594 1.252-1.816 2.925.178 3.865 1.018 9.287 8.277 25.465 24.596 31.02 35.665.248.495-1.506-11.808-.865-10.746"/><path d="M185.44 554.611v-4.04c0-2.692-.57-4.727-1.712-6.104-1.145-1.375-2.634-2.062-4.475-2.062-3.021-.056-5.026.505-6.021 1.686-.994 1.179-1.49 2.806-1.49 4.881l-.11 31.229c0 1.796.515 3.188 1.548 4.166 1.028.982 2.834 1.476 5.412 1.476 1.618.0 2.908-.295 3.866-.883.957-.593 1.692-1.334 2.21-2.231.515-.896.828-1.88.938-2.946.11-1.064.166-2.076.166-3.028v-5.726h19.442v7.744c0 2.693-.534 5.176-1.603 7.449-1.067 2.271-2.727 4.224-4.972 5.85-2.247 1.629-5.156 2.894-8.729 3.788-3.573.897-7.826 1.347-12.761 1.347-4.493.0-8.305-.447-11.435-1.347-3.132-.896-5.688-2.201-7.679-3.914-1.988-1.71-3.442-3.813-4.363-6.312-.922-2.497-1.382-5.349-1.382-8.545V551.16c0-6.899 2.117-11.979 6.354-15.233 4.232-3.254 10.808-4.883 19.72-4.883 4.124.0 7.823.353 11.104 1.054 3.275.702 6.058 1.782 8.341 3.239 2.282 1.461 4.033 3.354 5.248 5.684s1.821 5.092 1.821 8.29v5.304H185.44V554.611z"/><path fill="#fff" d="M231.8 574.649l-16.795-1.156 3.754-54.526 24.521 1.688c6.934.479 12.024 1.985 15.27 4.521 3.243 2.536 4.682 6.521 4.308 11.945-.2 2.909-.979 5.362-2.329 7.364-1.354 2.001-3.818 3.488-7.4 4.457l-.009.146c2.324.553 4.212 1.483 5.653 2.801 1.443 1.316 2.162 2.924 2.161 4.824.049 1.125.066 2.486.052 4.094-.013 1.604-.028 3.235-.047 4.892-.019 1.655-.018 3.236.007 4.749.023 1.514.135 2.712.329 3.603.389.854.887 1.521 1.49 2.002l-.051.729-18.317-1.261c-.219-.552-.392-1.086-.515-1.608-.125-.518-.199-1.046-.228-1.586.039-2.43.165-4.724.379-6.877.211-2.148.247-4.084.11-5.799-.139-1.712-.569-3.105-1.294-4.18-.726-1.074-2.071-1.726-4.036-1.958l-5.533-.381L231.8 574.649zM233.957 543.314l5.726.396c1.208.081 2.222-.041 3.045-.375.821-.334 1.479-.801 1.966-1.399s.842-1.305 1.058-2.118c.216-.812.354-1.631.409-2.455.108-1.6-.026-2.875-.409-3.827-.38-.949-1.034-1.679-1.958-2.18-.923-.501-2.132-.842-3.62-1.017-1.49-.177-3.255-.311-5.294-.401L233.957 543.314z"/><path d="M265.164 595.689l18.116-63.132h23.423l18.006 63.132h-19.663l-2.762-12.291h-15.246l-2.318 12.291H265.164zm29.828-51.684h-.222l-5.634 28.282h11.269L294.992 544.005z"/><path d="M352.709 556.745l-.223.168 1.77 35.188h-18.448v-63.132h19.995l15.024 35.269h.331l-1.88-35.269h18.45V592.1h-19.887l-15.132-35.355z"/><path d="M397.406 595.689v-63.132h44.521v12.625H416.85V556.8h24.305v12.627H416.85v13.636h26.403v12.627L397.406 595.689z"/><circle fill="#fff" cx="344.901" cy="536.967" r="3.136"/></svg></span><span class=font-weight-bold>Crane</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/main-docsy/docs/><i class='fas fa-book pr-2'></i><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/main-docsy/community/><i class='fab fa-youtube pr-2'></i><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/gocrane/crane target=_blank><i class='fab fa-github pr-2'></i><span>GitHub</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Releases</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://docs.gocrane.io/main-docsy>main</a>
<a class=dropdown-item href=https://docs.gocrane.io/release-0.7>release-0.7</a>
<a class=dropdown-item href=https://docs.gocrane.io/release-0.4/>release-0.4</a></div></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/main-docsy/zh-cn/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/>Chinese</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/main-docsy/zh-cn/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/>Chinese</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-main-docsydocs-li><a href=/main-docsy/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-main-docsydocs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsgetting-started-li><input type=checkbox id=m-main-docsydocsgetting-started-check>
<label for=m-main-docsydocsgetting-started-check><a href=/main-docsy/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsgetting-started><span>Getting Started</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsgetting-startedintroduction-li><input type=checkbox id=m-main-docsydocsgetting-startedintroduction-check>
<label for=m-main-docsydocsgetting-startedintroduction-check><a href=/main-docsy/docs/getting-started/introduction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsgetting-startedintroduction><span>Introduction</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsgetting-startedinstallation-li><input type=checkbox id=m-main-docsydocsgetting-startedinstallation-check>
<label for=m-main-docsydocsgetting-startedinstallation-check><a href=/main-docsy/docs/getting-started/installation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsgetting-startedinstallation><span>Installation</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocstutorials-li><input type=checkbox id=m-main-docsydocstutorials-check>
<label for=m-main-docsydocstutorials-check><a href=/main-docsy/docs/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocstutorials><span>Tutorials</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsanalytics-and-recommendation-li><input type=checkbox id=m-main-docsydocstutorialsanalytics-and-recommendation-check>
<label for=m-main-docsydocstutorialsanalytics-and-recommendation-check><a href=/main-docsy/docs/tutorials/analytics-and-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsanalytics-and-recommendation><span>Analytics and Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsdynamic-scheduler-plugin-li><input type=checkbox id=m-main-docsydocstutorialsdynamic-scheduler-plugin-check>
<label for=m-main-docsydocstutorialsdynamic-scheduler-plugin-check><a href=/main-docsy/docs/tutorials/dynamic-scheduler-plugin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsdynamic-scheduler-plugin><span>Dynamic-scheduler: a load-aware scheduler plugin</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsreplicas-recommendation-li><input type=checkbox id=m-main-docsydocstutorialsreplicas-recommendation-check>
<label for=m-main-docsydocstutorialsreplicas-recommendation-check><a href=/main-docsy/docs/tutorials/replicas-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsreplicas-recommendation><span>Replicas Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsresource-recommendation-li><input type=checkbox id=m-main-docsydocstutorialsresource-recommendation-check>
<label for=m-main-docsydocstutorialsresource-recommendation-check><a href=/main-docsy/docs/tutorials/resource-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsresource-recommendation><span>Resource Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load-li><input type=checkbox id=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load-check>
<label for=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load-check><a href=/main-docsy/docs/tutorials/scheduling-pods-based-on-actual-node-load/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load><span>Crane-scheduler</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp-li><input type=checkbox id=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp-check>
<label for=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp-check><a href=/main-docsy/docs/tutorials/timeseriees-forecasting-by-dsp/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp><span>DSP 预测算法</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness-li><input type=checkbox id=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness-check>
<label for=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness-check><a href=/main-docsy/docs/tutorials/using-effective-hpa-to-scaling-with-effectiveness/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness><span>Effective HorizontalPodAutoscaler</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsusing-qos-ensurance-li><input type=checkbox id=m-main-docsydocstutorialsusing-qos-ensurance-check>
<label for=m-main-docsydocstutorialsusing-qos-ensurance-check><a href=/main-docsy/docs/tutorials/using-qos-ensurance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsusing-qos-ensurance><span>QoS Ensurance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsusing-time-series-prediction-li><input type=checkbox id=m-main-docsydocstutorialsusing-time-series-prediction-check>
<label for=m-main-docsydocstutorialsusing-time-series-prediction-check><a href=/main-docsy/docs/tutorials/using-time-series-prediction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsusing-time-series-prediction><span>TimeSeriesPrediction</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsbest-practices-li><input type=checkbox id=m-main-docsydocsbest-practices-check>
<label for=m-main-docsydocsbest-practices-check><a href=/main-docsy/docs/best-practices/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsbest-practices><span>Best Practices</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter-li><input type=checkbox id=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter-check>
<label for=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter-check><a href=/main-docsy/docs/best-practices/effective-hpa-with-prometheus-adapter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter><span>Intelligent Autoscaling Practices Based on Effective HPA for Custom Metrics</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-main-docsydocsproposals-li><input type=checkbox id=m-main-docsydocsproposals-check checked>
<label for=m-main-docsydocsproposals-check><a href=/main-docsy/docs/proposals/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsproposals><span>Proposals</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposals20220228-advanced-cpuset-manger-li><input type=checkbox id=m-main-docsydocsproposals20220228-advanced-cpuset-manger-check>
<label for=m-main-docsydocsproposals20220228-advanced-cpuset-manger-check><a href=/main-docsy/docs/proposals/20220228-advanced-cpuset-manger/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposals20220228-advanced-cpuset-manger><span>Advanced CPUSet Manager</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposals20220402-policy-based-abnomal-detection-li><input type=checkbox id=m-main-docsydocsproposals20220402-policy-based-abnomal-detection-check>
<label for=m-main-docsydocsproposals20220402-policy-based-abnomal-detection-check><a href=/main-docsy/docs/proposals/20220402-policy-based-abnomal-detection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposals20220402-policy-based-abnomal-detection><span>Provide a policy-based abnormal detection mechanism in crane-agent</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposals20220706-recommendation-framework-li><input type=checkbox id=m-main-docsydocsproposals20220706-recommendation-framework-check>
<label for=m-main-docsydocsproposals20220706-recommendation-framework-check><a href=/main-docsy/docs/proposals/20220706-recommendation-framework/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposals20220706-recommendation-framework><span>Recommendation Framework</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent-li><input type=checkbox id=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent-check>
<label for=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent-check><a href=/main-docsy/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent><span class=td-sidebar-nav-active-item>Pod Sorting And Precise Execution For Crane Agent</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocscontributing-li><input type=checkbox id=m-main-docsydocscontributing-check>
<label for=m-main-docsydocscontributing-check><a href=/main-docsy/docs/contributing/ title=Contributing class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocscontributing><span>Contributing Guidelines</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocscontributingcontributing-li><input type=checkbox id=m-main-docsydocscontributingcontributing-check>
<label for=m-main-docsydocscontributingcontributing-check><a href=/main-docsy/docs/contributing/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocscontributingcontributing><span>Contributing to Crane</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocscontributingdeveloper-guide-li><input type=checkbox id=m-main-docsydocscontributingdeveloper-guide-check>
<label for=m-main-docsydocscontributingdeveloper-guide-check><a href=/main-docsy/docs/contributing/developer-guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocscontributingdeveloper-guide><span>Developer Guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocscontributingcode-standards-li><input type=checkbox id=m-main-docsydocscontributingcode-standards-check>
<label for=m-main-docsydocscontributingcode-standards-check><a href=/main-docsy/docs/contributing/code-standards/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocscontributingcode-standards><span>Code Standard</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsroadmap-li><input type=checkbox id=m-main-docsydocsroadmap-check>
<label for=m-main-docsydocsroadmap-check><a href=/main-docsy/docs/roadmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsroadmap><span>Roadmap</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsroadmaproadmap-2022-li><input type=checkbox id=m-main-docsydocsroadmaproadmap-2022-check>
<label for=m-main-docsydocsroadmaproadmap-2022-check><a href=/main-docsy/docs/roadmap/roadmap-2022/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsroadmaproadmap-2022><span>Roadmap for 2022</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsmirror-resources-li><input type=checkbox id=m-main-docsydocsmirror-resources-check>
<label for=m-main-docsydocsmirror-resources-check><a href=/main-docsy/docs/mirror-resources/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsmirror-resources><span>Mirror Resources</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#motivation>Motivation</a><ul><li><a href=#goals>Goals</a></li></ul></li><li><a href=#proposal>Proposal</a><ul><li><a href=#enrich-the-sorting-strategy-of-pod>Enrich the sorting strategy of pod</a></li><li><a href=#definition-of-metric-attribute>Definition of metric attribute</a></li><li><a href=#how-to-control-accurately-according-to-the-water-level>How to control accurately according to the water level</a></li><li><a href=#precise-operation-of-pod-based-on-water-level>Precise operation of pod based on water level</a></li><li><a href=#non-goalsfuture-work>Non-Goals/Future Work</a></li><li><a href=#user-stories>User Stories</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://docs.gocrane.io/main-docsy/docs/>Documentation</a></li><li class=breadcrumb-item><a href=https://docs.gocrane.io/main-docsy/docs/proposals/>Proposals</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://docs.gocrane.io/main-docsy/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/>Pod Sorting And Precise Execution For Crane Agent</a></li></ol></nav><div class=td-content><h1>Pod Sorting And Precise Execution For Crane Agent</h1><header class=article-meta><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i>&nbsp; 12 minute read &nbsp;</p></header><p>The proposal enriches the sorting strategy of the crane agent and perfects the general sorting. In addition, a framework of precise operation (throttle/eviction) is implemented. When performing throttle, eviction and other operations, the precise operation logic of operating to the water level specified by the user, i.e. stopping, avoids excessive operation of low optimal pod;</p><p>Specifically:</p><ul><li><p>Enriches the sorting strategy of crane agent, and perfects the general sorting and CPU dimension sorting with CPU usage as the main reference;</p></li><li><p>For CPU usage, the precise operation logic that stops when operating to the water level specified by the user when throttle/eviction is implemented, which avoids the excessive operation of low optimal pod;</p></li><li><p>A framework of precise operation (throttle/eviction) is implemented. By improving some column attributes and implementation of user-defined indicators, it can also have the same precise operation ability as CPU usage without caring about specific details, and has certain universality and scalability.</p></li></ul><h2 id=table-of-contents>Table of Contents</h2><ul><li>[Pod Sorting And Precise Execution For Crane Agent](#Pod Sorting And Precise Execution For Crane Agent)<ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#motivation>Motivation</a><ul><li><a href=#goals>Goals</a></li></ul></li><li><a href=#proposal>Proposal</a><ul><li>[Enrich the sorting strategy of pod](#Enrich the sorting strategy of pod)</li><li>[Definition of metric attribute](#Definition of metric attribute)</li><li>[How to control accurately according to the water level](#How to control accurately according to the water level)</li><li>[Precise operation of pod based on water level](#Precise operation of pod based on water level)<ul><li>[Analyzer phase](#Analyzer phase)</li><li>[Executor phase](#Executor phase)</li></ul></li><li><a href=#non-goalsfuture-work>Non-Goals/Future Work</a></li><li><a href=#user-stories>User Stories</a></li></ul></li></ul></li></ul><h2 id=motivation>Motivation</h2><p>Currently, in the crane agent, when the water level specified in the NodeQosEnsurancePolicy is exceeded, perform throttle, eviction and other operations to sort the low priority pods first. The current sorting is based on the prority class of the pod, and then perform throttle or eviction on the sorted pods;</p><p>The existing problems are:</p><ol><li><p>sorting only refers to prority class, which cannot meet the sorting based on other features; At the same time, it can not meet the requirements of flexible sequencing according to the precise operation of the water level line, and can not meet the requirements of making the nodes reach the specified water level as soon as possible. For example, when we want to reduce the CPU usage of low priority services as soon as possible, we should select the pod with more CPU usage, which can reduce the CPU usage faster and ensure that high-quality services are not affected.</p></li><li><p>after triggering the watermark specified in NodeQosEnsurancePolicy, all pods on the node that are lower than the specified prolityclass will be operated; For example, there are 10 pods on the current node that are lower than the specified prority class. After the water level is triggered, operations will be performed on all 10 pods. However, in fact, after the operation on the first pod is completed, it may be lower than the index value in NodeQosEnsurancePolicy. The operation on the remaining pods is excessive and can be avoided. If the index value in NodeQosEnsurancePolicy can be used as the watermark to accurately operate the pod, it is more appropriate to operate it just below the watermark, so as to avoid excessive impact on low priority services.</p></li></ol><h3 id=goals>Goals</h3><ul><li><p>Enriches the sorting strategy of crane agent, including the sorting with pod CPU consumption as the main reference, the sorting with pod memory consumption as the main reference, the sorting based on runtime, and the sorting based on extended resource utilization.</p></li><li><p>Implement a framework including sorting and a precise operation, support to enrich sorting rules for different indicators, and realize precise operation.</p></li><li><p>To achieve a precise operation for CPU usage and memory usage, when the machine load exceeds the water level specified in NodeQosEnsurancePolicy, the low priority pods will be sorted first, and then the operation will be carried out in order until it is just below the water level.</p></li></ul><h2 id=proposal>Proposal</h2><h3 id=enrich-the-sorting-strategy-of-pod>Enrich the sorting strategy of pod</h3><ul><li><p>The proposal implements some general sorting methods (which will be improved later):</p><p>classAndPriority： Compare the Qos class and class value of two pods. Compare Qos class first and then class value; Those with high priority are ranked later and have higher priority</p><p>runningTime：Compare the running time of two pods. The one with a long running time is ranked later and has a higher priority</p><p>If you only need to use these two sorting strategies, you can use the default sorting method: you will first compare the priority of the pod, then compare the usage of the corresponding indicators of the pod, and then compare the running time of the pod. There is a dimension that can compare the results, that is, the sorting results of the pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GeneralSorter</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>PodContext</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>orderedBy</span>(<span style=color:#a6e22e>classAndPriority</span>, <span style=color:#a6e22e>runningTime</span>).<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Sorting of CPU usage</p><p>The priority of two pods will be compared in turn. If the priority is the same, then compare the CPU usage. If the CPU usage is also the same, continue to compare the EXT CPU resource usage (this is a special point of the CPU attribute). Finally, compare the running time of the pod. When there is a difference in a certain index, the comparison result can be returned</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CpuUsageSorter</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>PodContext</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>orderedBy</span>(<span style=color:#a6e22e>classAndPriority</span>, <span style=color:#a6e22e>cpuUsage</span>, <span style=color:#a6e22e>extCpuUsage</span>, <span style=color:#a6e22e>runningTime</span>).<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Sorting of ext CPU usage</p><p>First, it will compare whether the extended CPU resources are used by two pods. If both are used, it will compare the ratio of the extended CPU resource usage / the extended CPU resource limit</p></li><li><p>For the indicators that need to be customized, the following methods can be implemented, and the flexible and customized sorting of pods can be easily realized by freely matching the general sorting methods. The <metric>represents the customized metric indicators, and the <metric sort func>represents the customized sorting strategy for <metric></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> &lt;<span style=color:#a6e22e>metric</span>&gt;<span style=color:#a6e22e>Sorter</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>PodContext</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>orderedBy</span>(<span style=color:#a6e22e>classAndPriority</span>, &lt;<span style=color:#a6e22e>metric</span><span style=color:#f92672>-</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>-</span><span style=color:#66d9ef>func</span>&gt;, <span style=color:#a6e22e>runningTime</span>).<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <metric sort func>only needs to implement the following sorting methods</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p1</span>, <span style=color:#a6e22e>p2</span> <span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>PodContext</span>) <span style=color:#66d9ef>int32</span> 
</span></span></code></pre></div></li></ul><h3 id=definition-of-metric-attribute>Definition of metric attribute</h3><p>In order to better sort and precisely control metrics configured based on NodeQosEnsurancePolicy, the concept of attributes is introduced into metrics.</p><p>The attributes of metrics include the following:</p><ol><li>Name indicates the name of the metric, which should be consistent with the indicator name collected in the collector module</li><li>ActionPriority indicates the priority of the indicator. 0 is the lowest and 10 is the highest</li><li>SortAble indicates whether the indicator can be sorted</li><li>Sorting methods corresponding to SortFunc. Sorting methods can be arranged and combined with some general methods, and then combined with the sorting of indicators, which will be introduced in detail below</li><li>ThrottleAble indicates whether pod can be suppressed for this indicator. For example, for the metric of CPU usage, there are corresponding suppression methods. However, for the indicator of memory usage, the pod can only be expelled, and effective suppression cannot be carried out</li><li>ThrottleQuantified indicates whether the corresponding metric resources released after the suppression can be accurately calculated after a pod is restored. We call the indicators that can be accurately quantified quantifiable, otherwise, they are not quantifiable;
For example, the CPU usage can be suppressed by limiting the CGroup usage, and the CPU usage released after suppression can be calculated by the current running value and the value after suppression; For example, memory usage does not belong to the suppression quantifiable metric, because memory has no corresponding throttle implementation, so it is impossible to accurately measure the specific amount of memory resources released after suppressing a pod;</li><li>ThrottleFunc, the specific method to execute the throttle action. If throttling is not available, the returned released is null</li><li>RestoreFunc: after being throttled, the specific method to execute the recovery action. If throttling is not allowed, the returned released is null</li><li>Relevant definitions of evicting actions by evictable, evictquantified, and evictfunc are similar to those of throttle actions</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>metric</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span> <span style=color:#a6e22e>WaterLineMetric</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ActionPriority</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SortAble</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SortFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>PodContext</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ThrottleAble</span>      <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ThrottleQuantified</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ThrottleFunc</span>      <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecuteContext</span>, <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ThrottleDownPods</span> <span style=color:#a6e22e>ThrottlePods</span>, <span style=color:#a6e22e>totalReleasedResource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReleaseResource</span>) (<span style=color:#a6e22e>errPodKeys</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RestoreFunc</span>       <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecuteContext</span>, <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ThrottleUpPods</span> <span style=color:#a6e22e>ThrottlePods</span>, <span style=color:#a6e22e>totalReleasedResource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReleaseResource</span>) (<span style=color:#a6e22e>errPodKeys</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EvictAble</span>      <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EvictQuantified</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EvictFunc</span>      <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecuteContext</span>, <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>totalReleasedResource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReleaseResource</span>, <span style=color:#a6e22e>EvictPods</span> <span style=color:#a6e22e>EvictPods</span>) (<span style=color:#a6e22e>errPodKeys</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can define your own metric. After the construction is completed, you can register it through registermetricmap()</p><h3 id=how-to-control-accurately-according-to-the-water-level>How to control accurately according to the water level</h3><ul><li><p>Build multiple waterlines according to multiple nodeqosensurancepolicies and objectiveinsurances:</p><ol><li><p>Classified according to the actions corresponding to objectiveinsurances, the crane agent currently has three operations to guarantee node QoS, namely, evict, thtottledown (to suppress pod usage when the current usage is higher than the value in objectiveinsurances) and throttleup (to relax and recover pod usage when the current usage is lower than the value in objectiveinsurances). Therefore, there will be three waterline sets, namely, throttledownwaterline, Throttleupwaterline and evictwaterline</p></li><li><p>Then classify the waterlines in the same operation category according to their metric rules (metric A and metric Z are used as schematic in the figure), and record the value of each objectiveinsurances water level line, which is recorded as waterline;</p><p>The structures of throttledownwaterline, throttleupwaterline and evictwaterline are as follows:
<code>type WaterLines map[WaterLineMetric]*WaterLine</code></p><p>Where waterlinemetric is the name field of the above metric, and waterline of value is the resource value
<code>type WaterLine resource.Quantity</code></p></li></ol><p>Finally, a data store similar to the following figure is formed:<br><img src=/images/waterline-construct.png alt></p></li><li><p>Construct the difference between real-time consumption and waterline:
The following data structure is constructed by combining the difference between the real-time consumption of the indicator at the current node and the minimum value in the waterline corresponding to the indicator in waterlines, representing the difference between the current consumption and the waterline
<code>type GapToWaterLines map[WaterLineMetric]float64</code></p><p>Where the key value is the name field of metric, and the value is the difference between the consumption and the waterline;</p><p>It should be noted that for throttleup, the minimum waterline - current usage is used as the gap value. For the other two, the minimum waterline - current usage is used as the gap value, that is, the gap value is always kept positive</p><p>The following three data represent the indicators that need to perform evict, thatttledown and throttleup operations and their corresponding differences to the lowest waterline</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>EvictGapToWaterLines</span>[<span style=color:#a6e22e>metrics</span>]     
</span></span><span style=display:flex><span><span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>[<span style=color:#a6e22e>metrics</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>ThrottleUpGapWaterLine</span>[<span style=color:#a6e22e>metrics</span>]
</span></span></code></pre></div></li><li><p>Taking the metric CpuUsage as an example, the process and data structure of constructing the waterline related to node CPU usage are as follows:
<img src=/images/cpu-usage-water-line.png alt></p></li></ul><h3 id=precise-operation-of-pod-based-on-water-level>Precise operation of pod based on water level</h3><p>In order to realize the precise operation of pod based on the water level, the proposal will modify the analyzer and executor. The general process is as follows:</p><p>In the analyzer phase, construct waterlines for different operations (eviction, throttle, etc.) and different metrics, delete the original sorting logic, and move it to the executor phase where formal operations are required, and multiple rounds of sorting may be required;</p><p>In the executor stage, the corresponding sorting is carried out according to the indicators involved in the waterline, the latest consumption is obtained, gaptowaterlines is constructed, and precise operations are carried out</p><h4 id=analyzer-phase>Analyzer phase</h4><p>At this stage, the NodeQosEnsurancePolicy is converted to waterlines, and the rules of the same actionname and metricreule are merged. The details have been described above</p><h4 id=executor-phase>Executor phase</h4><p>Throttle:</p><ol><li><p>Firstly, analyze the metrics involved in the ThrottoleDownGapToWaterLines, and divide these metrics into two parts according to their quantized attribute. If there is a metric that cannot be quantized, get the metric of a throttleable (with a throttlefunc) with the highest action priority through gethighstprioritythottleablemetric to suppress all the selected pods, because if there is a metric that cannot be quantized, It is impossible to carry out a precise operation</p></li><li><p>Get the latest usage of the current node and workload through getstatefunc(), Construct the gaptowaterline according to the ThrottoleDownGapToWaterLines and real-time usage (note that when constructing the gaptowaterline, it will traverse with the registered metric, so the finally constructed metric in the gaptowaterline will be the metric registered in the ThrottoleDownGapToWaterLines, avoiding the situation that the configuration error does not exist or the metric is not registered in the nodeqosensancepolicy)</p></li><li><p>If there is a metric in the gaptowaterline whose real-time usage cannot be obtained (hasusagemissedmetric), obtain the metric of a throttleable (with throttlefunc) with the highest action priority through GetHighestPriorityThrottleAbleMetric to suppress all the selected pods, because if there is a metric whose real-time usage cannot be obtained, the gap with the waterline cannot be known, and precise operations cannot be performed</p></li><li><p>If the situation in 3 does not exist, traverse the quantifiable metrics in the ThrottoleDownGapToWaterLines: if the metric has a sorting method, it directly uses its sortfunc to sort the pods. If not, it uses generalsorter to sort the pods, and then uses its corresponding throttlefunc to suppress the pods, and calculate the released resources of the corresponding metric, Until the gap corresponding to this metric in ThrottoleDownGapToWaterLines no longer exists</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>metricsQuantified</span>, <span style=color:#a6e22e>MetricsNotQuantified</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ThrottleDownWaterLine</span>.<span style=color:#a6e22e>DivideMetricsByQuantified</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>MetricsNotThrottleQuantified</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetHighestPriorityThrottleAbleMetric</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>throttlePods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>highestPrioriyMetric</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span> = <span style=color:#a6e22e>buildGapToWaterLine</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>getStateFunc</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>.<span style=color:#a6e22e>HasUsageMissedMetric</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ThrottleDownWaterLine</span>.<span style=color:#a6e22e>GetHighestPriorityThrottleAbleMetric</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>throttlePods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>highestPrioriyMetric</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>metricsQuantified</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SortAble</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SortFunc</span>(<span style=color:#a6e22e>ThrottleDownPods</span>)
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>GeneralSorter</span>(<span style=color:#a6e22e>ThrottleDownPods</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>.<span style=color:#a6e22e>TargetGapsRemoved</span>(<span style=color:#a6e22e>m</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ThrottleDownPods</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>released</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>ThrottleFunc</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>ThrottleDownPods</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>)
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>[<span style=color:#a6e22e>m</span>] <span style=color:#f92672>-=</span> <span style=color:#a6e22e>released</span>[<span style=color:#a6e22e>m</span>]
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Eviction：</p><p>The process of eviction and throttle is the same, except that it is necessary to judge whether the pod has been expelled when operating the pod; Take out a pod that has not been executed, execute the eviction operation, calculate the released metric resources, and subtract the released value from the corresponding water level until the current metric waterline requirements are met</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>metricsEvictQuantified</span>, <span style=color:#a6e22e>MetricsNotEvcitQuantified</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>EvictWaterLine</span>.<span style=color:#a6e22e>DivideMetricsByEvictQuantified</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>MetricsNotEvcitQuantified</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictWaterLine</span>.<span style=color:#a6e22e>GetHighestPriorityEvictAbleMetric</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>evictPods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>highestPrioriyMetric</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>EvictGapToWaterLines</span> = <span style=color:#a6e22e>buildGapToWaterLine</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>getStateFunc</span>(), <span style=color:#a6e22e>ThrottleExecutor</span>{}, <span style=color:#f92672>*</span><span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>EvictGapToWaterLines</span>.<span style=color:#a6e22e>HasUsageMissedMetric</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>EvictWaterLine</span>.<span style=color:#a6e22e>GetHighestPriorityEvictAbleMetric</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>evictPods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>highestPrioriyMetric</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>metricsEvictQuantified</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>MetricMap</span>[<span style=color:#a6e22e>m</span>].<span style=color:#a6e22e>SortAble</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>MetricMap</span>[<span style=color:#a6e22e>m</span>].<span style=color:#a6e22e>SortFunc</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictPods</span>)
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>execsort</span>.<span style=color:#a6e22e>GeneralSorter</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictPods</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>EvictGapToWaterLines</span>.<span style=color:#a6e22e>TargetGapsRemoved</span>(<span style=color:#a6e22e>m</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>HasNoExecutedPod</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictPods</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>GetFirstNoExecutedPod</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictPods</span>)
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>released</span> = <span style=color:#a6e22e>MetricMap</span>[<span style=color:#a6e22e>m</span>].<span style=color:#a6e22e>EvictFunc</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>index</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictPods</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>EvictPods</span>[<span style=color:#a6e22e>index</span>].<span style=color:#a6e22e>HasBeenActioned</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>EvictGapToWaterLines</span>[<span style=color:#a6e22e>m</span>] <span style=color:#f92672>-=</span> <span style=color:#a6e22e>released</span>[<span style=color:#a6e22e>m</span>]
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=non-goalsfuture-work>Non-Goals/Future Work</h3><ul><li>Currently, only the precise operation of CPU usage is supported, but the framework can be reused. In the future, the framework based on precise control can achieve precise control of more dimensional indicators.</li><li>In the process of precise control, only the release of metric is considered at present, and the interaction between different metrics is not considered. For example, when pressing CPU usage, memory usage will also be affected. If there are many indicators, the relationship between different indicators will be very complex, so the direct interaction of different metrics will not be considered for the time being.</li></ul><h3 id=user-stories>User Stories</h3><ul><li>Users can use crane agent for better QoS guarantees. Support faster node load reduction to ensure that high priority services are not affected. At the same time, the throttle/eviction of low priority services is precisely controlled to avoid excessive operation.</li><li>With the help of the framework of precise operation (throttle/eviction), users can easily realize the QoS function with precise operation and sorting capability based on the user-defined metric without paying attention to details by implementing the attributes and methods related to the user-defined metric.</li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/gocrane/shared_invite/zt-1ehm9871y-Zgs5pXxSIhYg5hGSc5XZgQ aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Community Meetings" aria-label="Community Meetings"><a class=text-white target=_blank rel=noopener href=https://www.wolai.com/33xC4HB1JXCCH1x8umfioS aria-label="Community Meetings"><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/gocrane/crane aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/gocrane/shared_invite/zt-1ehm9871y-Zgs5pXxSIhYg5hGSc5XZgQ aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Community Meetings" aria-label="Community Meetings"><a class=text-white target=_blank rel=noopener href=https://www.wolai.com/33xC4HB1JXCCH1x8umfioS aria-label="Community Meetings"><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Crane Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/main-docsy/js/main.min.780da35d51262201dbdab6376e49da7e3951a292d004e80aa25302ba49e27b5d.js integrity="sha256-eA2jXVEmIgHb2rY3bknafjlRopLQBOgKolMCuknie10=" crossorigin=anonymous></script></body></html>