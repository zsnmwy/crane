<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.102.3"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/main-docsy/favicons/favicon.ico><link rel=apple-touch-icon href=/main-docsy/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/main-docsy/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/main-docsy/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/main-docsy/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/main-docsy/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/main-docsy/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/main-docsy/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/main-docsy/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/main-docsy/favicons/android-192x192.png sizes=192x192><title>QoS Ensurance | Crane</title><meta name=description content="Introduction for QoS Ensurance"><meta property="og:title" content="QoS Ensurance"><meta property="og:description" content="Introduction for QoS Ensurance"><meta property="og:type" content="article"><meta property="og:url" content="https://docs.gocrane.io/main-docsy/docs/tutorials/using-qos-ensurance/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-09-18T22:20:58+08:00"><meta property="og:site_name" content="Crane"><meta itemprop=name content="QoS Ensurance"><meta itemprop=description content="Introduction for QoS Ensurance"><meta itemprop=dateModified content="2022-09-18T22:20:58+08:00"><meta itemprop=wordCount content="2484"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="QoS Ensurance"><meta name=twitter:description content="Introduction for QoS Ensurance"><link rel=preload href=/main-docsy/scss/main.min.f4870c69a3526683406b314140cdd0fe00001c7dfe1b1b9bd6bd473abba6c143.css as=style><link href=/main-docsy/scss/main.min.f4870c69a3526683406b314140cdd0fe00001c7dfe1b1b9bd6bd473abba6c143.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/main-docsy/><span class=navbar-logo><svg id="图层_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="306" height="186" viewBox="144.139 425.446 306 186" enable-background="new 144.139 425.446 306 186"><path fill="#58bda6" d="M267.919 572.702c-.372 5.728-4.972 10.091-10.27 9.743l-40.779-2.65c-5.3-.347-9.293-5.269-8.923-10.991l2.974-45.702c.373-5.728 4.973-10.088 10.271-9.743l40.78 2.652c5.299.345 9.293 5.267 8.921 10.99L267.919 572.702z"/><path fill="#ee7300" d="M355.802 528.969c-28.058-24.713-63.021-62.657-91.196-87.232-1.938-1.69-5.604-3.409-7.457-2.647-1.938.795-3.404 4.46-3.778 7.058-1.761 12.192-2.91 28.237-4.656 40.433-.437 3.041-1.971 6.067-3.571 8.762-2.041 3.435-.873 12.792 2.958 15.723 3.085 2.357 4.303 5.096 1.854 7.834-1.351 1.512-4.525 1.391-6.992 2.032 2.374 2.482 5.765 2.633 9.24-.084 3.808-2.979 2.631-7.084-4.054-14.46 4.628-3.659 5.886-7.839 2.424-13.33-1.104-1.75-.191-4.886.068-7.356 1.027-9.761 2.094-23.278 3.315-33.019.292-2.324 1.237-4.564 2.349-8.479 26.078 34.224 56.794 78.868 82.623 112.767.93-6.764-.387-17.9-.708-23.131-.193-3.154-5.785-8.536-7.861-11.352-3.039-4.109-6.746-7.742-9.644-11.94-.76-1.101-.824-2.206.128-3.594 1.252-1.816 2.925.178 3.865 1.018 9.287 8.277 25.465 24.596 31.02 35.665.248.495-1.506-11.808-.865-10.746"/><path d="M185.44 554.611v-4.04c0-2.692-.57-4.727-1.712-6.104-1.145-1.375-2.634-2.062-4.475-2.062-3.021-.056-5.026.505-6.021 1.686-.994 1.179-1.49 2.806-1.49 4.881l-.11 31.229c0 1.796.515 3.188 1.548 4.166 1.028.982 2.834 1.476 5.412 1.476 1.618.0 2.908-.295 3.866-.883.957-.593 1.692-1.334 2.21-2.231.515-.896.828-1.88.938-2.946.11-1.064.166-2.076.166-3.028v-5.726h19.442v7.744c0 2.693-.534 5.176-1.603 7.449-1.067 2.271-2.727 4.224-4.972 5.85-2.247 1.629-5.156 2.894-8.729 3.788-3.573.897-7.826 1.347-12.761 1.347-4.493.0-8.305-.447-11.435-1.347-3.132-.896-5.688-2.201-7.679-3.914-1.988-1.71-3.442-3.813-4.363-6.312-.922-2.497-1.382-5.349-1.382-8.545V551.16c0-6.899 2.117-11.979 6.354-15.233 4.232-3.254 10.808-4.883 19.72-4.883 4.124.0 7.823.353 11.104 1.054 3.275.702 6.058 1.782 8.341 3.239 2.282 1.461 4.033 3.354 5.248 5.684s1.821 5.092 1.821 8.29v5.304H185.44V554.611z"/><path fill="#fff" d="M231.8 574.649l-16.795-1.156 3.754-54.526 24.521 1.688c6.934.479 12.024 1.985 15.27 4.521 3.243 2.536 4.682 6.521 4.308 11.945-.2 2.909-.979 5.362-2.329 7.364-1.354 2.001-3.818 3.488-7.4 4.457l-.009.146c2.324.553 4.212 1.483 5.653 2.801 1.443 1.316 2.162 2.924 2.161 4.824.049 1.125.066 2.486.052 4.094-.013 1.604-.028 3.235-.047 4.892-.019 1.655-.018 3.236.007 4.749.023 1.514.135 2.712.329 3.603.389.854.887 1.521 1.49 2.002l-.051.729-18.317-1.261c-.219-.552-.392-1.086-.515-1.608-.125-.518-.199-1.046-.228-1.586.039-2.43.165-4.724.379-6.877.211-2.148.247-4.084.11-5.799-.139-1.712-.569-3.105-1.294-4.18-.726-1.074-2.071-1.726-4.036-1.958l-5.533-.381L231.8 574.649zM233.957 543.314l5.726.396c1.208.081 2.222-.041 3.045-.375.821-.334 1.479-.801 1.966-1.399s.842-1.305 1.058-2.118c.216-.812.354-1.631.409-2.455.108-1.6-.026-2.875-.409-3.827-.38-.949-1.034-1.679-1.958-2.18-.923-.501-2.132-.842-3.62-1.017-1.49-.177-3.255-.311-5.294-.401L233.957 543.314z"/><path d="M265.164 595.689l18.116-63.132h23.423l18.006 63.132h-19.663l-2.762-12.291h-15.246l-2.318 12.291H265.164zm29.828-51.684h-.222l-5.634 28.282h11.269L294.992 544.005z"/><path d="M352.709 556.745l-.223.168 1.77 35.188h-18.448v-63.132h19.995l15.024 35.269h.331l-1.88-35.269h18.45V592.1h-19.887l-15.132-35.355z"/><path d="M397.406 595.689v-63.132h44.521v12.625H416.85V556.8h24.305v12.627H416.85v13.636h26.403v12.627L397.406 595.689z"/><circle fill="#fff" cx="344.901" cy="536.967" r="3.136"/></svg></span><span class=font-weight-bold>Crane</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/main-docsy/docs/><i class='fas fa-book pr-2'></i><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/main-docsy/community/><i class='fab fa-youtube pr-2'></i><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/gocrane/crane target=_blank><i class='fab fa-github pr-2'></i><span>GitHub</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Releases</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://docs.gocrane.io/main-docsy>main</a>
<a class=dropdown-item href=https://docs.gocrane.io/release-0.7>release-0.7</a>
<a class=dropdown-item href=https://docs.gocrane.io/release-0.4/>release-0.4</a></div></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/main-docsy/zh-cn/docs/tutorials/using-qos-ensurance/>Chinese</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/main-docsy/zh-cn/docs/tutorials/using-qos-ensurance/>Chinese</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-main-docsydocs-li><a href=/main-docsy/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-main-docsydocs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsgetting-started-li><input type=checkbox id=m-main-docsydocsgetting-started-check>
<label for=m-main-docsydocsgetting-started-check><a href=/main-docsy/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsgetting-started><span>Getting Started</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsgetting-startedintroduction-li><input type=checkbox id=m-main-docsydocsgetting-startedintroduction-check>
<label for=m-main-docsydocsgetting-startedintroduction-check><a href=/main-docsy/docs/getting-started/introduction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsgetting-startedintroduction><span>Introduction</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsgetting-startedinstallation-li><input type=checkbox id=m-main-docsydocsgetting-startedinstallation-check>
<label for=m-main-docsydocsgetting-startedinstallation-check><a href=/main-docsy/docs/getting-started/installation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsgetting-startedinstallation><span>Installation</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-main-docsydocstutorials-li><input type=checkbox id=m-main-docsydocstutorials-check checked>
<label for=m-main-docsydocstutorials-check><a href=/main-docsy/docs/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocstutorials><span>Tutorials</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsanalytics-and-recommendation-li><input type=checkbox id=m-main-docsydocstutorialsanalytics-and-recommendation-check>
<label for=m-main-docsydocstutorialsanalytics-and-recommendation-check><a href=/main-docsy/docs/tutorials/analytics-and-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsanalytics-and-recommendation><span>Analytics and Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsdynamic-scheduler-plugin-li><input type=checkbox id=m-main-docsydocstutorialsdynamic-scheduler-plugin-check>
<label for=m-main-docsydocstutorialsdynamic-scheduler-plugin-check><a href=/main-docsy/docs/tutorials/dynamic-scheduler-plugin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsdynamic-scheduler-plugin><span>Dynamic-scheduler: a load-aware scheduler plugin</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsreplicas-recommendation-li><input type=checkbox id=m-main-docsydocstutorialsreplicas-recommendation-check>
<label for=m-main-docsydocstutorialsreplicas-recommendation-check><a href=/main-docsy/docs/tutorials/replicas-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsreplicas-recommendation><span>Replicas Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsresource-recommendation-li><input type=checkbox id=m-main-docsydocstutorialsresource-recommendation-check>
<label for=m-main-docsydocstutorialsresource-recommendation-check><a href=/main-docsy/docs/tutorials/resource-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsresource-recommendation><span>Resource Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load-li><input type=checkbox id=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load-check>
<label for=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load-check><a href=/main-docsy/docs/tutorials/scheduling-pods-based-on-actual-node-load/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsscheduling-pods-based-on-actual-node-load><span>Crane-scheduler</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp-li><input type=checkbox id=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp-check>
<label for=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp-check><a href=/main-docsy/docs/tutorials/timeseriees-forecasting-by-dsp/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialstimeseriees-forecasting-by-dsp><span>DSP 预测算法</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness-li><input type=checkbox id=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness-check>
<label for=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness-check><a href=/main-docsy/docs/tutorials/using-effective-hpa-to-scaling-with-effectiveness/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsusing-effective-hpa-to-scaling-with-effectiveness><span>Effective HorizontalPodAutoscaler</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsusing-qos-ensurance-li><input type=checkbox id=m-main-docsydocstutorialsusing-qos-ensurance-check>
<label for=m-main-docsydocstutorialsusing-qos-ensurance-check><a href=/main-docsy/docs/tutorials/using-qos-ensurance/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsusing-qos-ensurance><span class=td-sidebar-nav-active-item>QoS Ensurance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocstutorialsusing-time-series-prediction-li><input type=checkbox id=m-main-docsydocstutorialsusing-time-series-prediction-check>
<label for=m-main-docsydocstutorialsusing-time-series-prediction-check><a href=/main-docsy/docs/tutorials/using-time-series-prediction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocstutorialsusing-time-series-prediction><span>TimeSeriesPrediction</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsbest-practices-li><input type=checkbox id=m-main-docsydocsbest-practices-check>
<label for=m-main-docsydocsbest-practices-check><a href=/main-docsy/docs/best-practices/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsbest-practices><span>Best Practices</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter-li><input type=checkbox id=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter-check>
<label for=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter-check><a href=/main-docsy/docs/best-practices/effective-hpa-with-prometheus-adapter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsbest-practiceseffective-hpa-with-prometheus-adapter><span>Intelligent Autoscaling Practices Based on Effective HPA for Custom Metrics</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsproposals-li><input type=checkbox id=m-main-docsydocsproposals-check>
<label for=m-main-docsydocsproposals-check><a href=/main-docsy/docs/proposals/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsproposals><span>Proposals</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposals20220228-advanced-cpuset-manger-li><input type=checkbox id=m-main-docsydocsproposals20220228-advanced-cpuset-manger-check>
<label for=m-main-docsydocsproposals20220228-advanced-cpuset-manger-check><a href=/main-docsy/docs/proposals/20220228-advanced-cpuset-manger/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposals20220228-advanced-cpuset-manger><span>Advanced CPUSet Manager</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposals20220402-policy-based-abnomal-detection-li><input type=checkbox id=m-main-docsydocsproposals20220402-policy-based-abnomal-detection-check>
<label for=m-main-docsydocsproposals20220402-policy-based-abnomal-detection-check><a href=/main-docsy/docs/proposals/20220402-policy-based-abnomal-detection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposals20220402-policy-based-abnomal-detection><span>Provide a policy-based abnormal detection mechanism in crane-agent</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposals20220706-recommendation-framework-li><input type=checkbox id=m-main-docsydocsproposals20220706-recommendation-framework-check>
<label for=m-main-docsydocsproposals20220706-recommendation-framework-check><a href=/main-docsy/docs/proposals/20220706-recommendation-framework/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposals20220706-recommendation-framework><span>Recommendation Framework</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent-li><input type=checkbox id=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent-check>
<label for=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent-check><a href=/main-docsy/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsproposalspod-sorting-and-precise-execution-for-crane-agent><span>Pod Sorting And Precise Execution For Crane Agent</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocscontributing-li><input type=checkbox id=m-main-docsydocscontributing-check>
<label for=m-main-docsydocscontributing-check><a href=/main-docsy/docs/contributing/ title=Contributing class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocscontributing><span>Contributing Guidelines</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocscontributingcontributing-li><input type=checkbox id=m-main-docsydocscontributingcontributing-check>
<label for=m-main-docsydocscontributingcontributing-check><a href=/main-docsy/docs/contributing/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocscontributingcontributing><span>Contributing to Crane</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocscontributingdeveloper-guide-li><input type=checkbox id=m-main-docsydocscontributingdeveloper-guide-check>
<label for=m-main-docsydocscontributingdeveloper-guide-check><a href=/main-docsy/docs/contributing/developer-guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocscontributingdeveloper-guide><span>Developer Guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocscontributingcode-standards-li><input type=checkbox id=m-main-docsydocscontributingcode-standards-check>
<label for=m-main-docsydocscontributingcode-standards-check><a href=/main-docsy/docs/contributing/code-standards/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocscontributingcode-standards><span>Code Standard</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-main-docsydocsroadmap-li><input type=checkbox id=m-main-docsydocsroadmap-check>
<label for=m-main-docsydocsroadmap-check><a href=/main-docsy/docs/roadmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsroadmap><span>Roadmap</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsroadmaproadmap-2022-li><input type=checkbox id=m-main-docsydocsroadmaproadmap-2022-check>
<label for=m-main-docsydocsroadmaproadmap-2022-check><a href=/main-docsy/docs/roadmap/roadmap-2022/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-main-docsydocsroadmaproadmap-2022><span>Roadmap for 2022</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-main-docsydocsmirror-resources-li><input type=checkbox id=m-main-docsydocsmirror-resources-check>
<label for=m-main-docsydocsmirror-resources-check><a href=/main-docsy/docs/mirror-resources/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-main-docsydocsmirror-resources><span>Mirror Resources</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#qos-ensurance-architecture>Qos Ensurance Architecture</a></li><li><a href=#interference-detection-and-active-avoidance>Interference Detection and Active Avoidance</a><ul><li><a href=#disable-scheduling>Disable Scheduling</a></li><li><a href=#throttle>Throttle</a></li><li><a href=#eviction>Eviction</a></li><li><a href=#supported-metrics>Supported Metrics</a></li><li><a href=#accurately-perform-avoidance-actions>Accurately Perform Avoidance Actions</a></li></ul></li><li><a href=#enhanced-bypass-cpuset-management-capability>Enhanced bypass cpuset management capability</a></li><li><a href=#dynamic-resource-oversold-enhanced-by-prediction-algorithm>Dynamic resource oversold enhanced by prediction algorithm</a></li><li><a href=#elastic-resource-restriction-function>Elastic resource restriction function</a></li><li><a href=#user-defined-metrics-interference-detection-avoidance-and-user-defined-sorting>User-defined metrics interference detection avoidance and user-defined sorting</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://docs.gocrane.io/main-docsy/docs/>Documentation</a></li><li class=breadcrumb-item><a href=https://docs.gocrane.io/main-docsy/docs/tutorials/>Tutorials</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://docs.gocrane.io/main-docsy/docs/tutorials/using-qos-ensurance/>QoS Ensurance</a></li></ol></nav><div class=td-content><h1>QoS Ensurance</h1><div class=lead>Introduction for QoS Ensurance</div><header class=article-meta><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i>&nbsp; 12 minute read &nbsp;</p></header><p>QoS ensurance guarantees the stability of the pods running on Kubernetes.</p><p>It has the ability of interference detection and active avoidance. When pod with higher priority is affected by resource competition, disable schedule, throttle and evict will be applied to pod with lower priority to support interference detection and user-defined operation of user-defined indicators;</p><p>At the same time, it has enhanced bypass cpuset management capability to improve resource utilization efficiency while binding cores.</p><p>It has the dynamic resource oversold ability enhanced by the prediction algorithm, and reuses the idle resources. At the same time, it combines the prediction ability of the crane to better reuse the idle resources. At the same time, it has the elastic resource limitation function to limit the workload of reusing idle resources.</p><h2 id=qos-ensurance-architecture>Qos Ensurance Architecture</h2><p>Qos ensurance&rsquo;s architecture is shown as below. It contains three modules.</p><ol><li>state collector: collect metrics periodically</li><li>anomaly analyzer: analyze the node triggered anomaly used collected metrics</li><li>action executor: execute avoidance actions, include disable scheduling, throttle and eviction.</li></ol><p><img src=/images/crane-qos-ensurance.png alt=crane-qos-enurance></p><p>The main process:</p><ol><li>State collector synchronizes policies from kube-apiserver.</li><li>If the policies are changed, the state collector updates the collectors.</li><li>State collector collects metrics periodically.</li><li>State collector transmits metrics to anomaly analyzer.</li><li>Anomaly analyzer ranges all rules to analyze the avoidance threshold or the restored threshold reached.</li><li>Anomaly analyzer merges the analyzed results and notices the avoidance actions.</li><li>Action executor executes actions based on the analyzed results.</li></ol><h2 id=interference-detection-and-active-avoidance>Interference Detection and Active Avoidance</h2><h3 id=disable-scheduling>Disable Scheduling</h3><p>The following AvoidanceAction and NodeQOSEnsurancePolicy can be defined. As a result, when the node CPU usage triggers the threshold, disable schedule action for the node will be executed.</p><p>The sample YAML looks like below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AvoidanceAction</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disablescheduling</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>disable schedule new pods to the node</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>coolDownSeconds</span>: <span style=color:#ae81ff>300</span>  <span style=color:#75715e># The minimum wait time of the node from  scheduling disable status to normal status</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NodeQOSEnsurancePolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;waterline1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;system&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodeQualityProbe</span>: 
</span></span><span style=display:flex><span>    <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodeLocalGet</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>localCacheTTLSeconds</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>objectiveEnsurances</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;cpu-usage&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>avoidanceThreshold</span>: <span style=color:#ae81ff>2</span> <span style=color:#75715e>#(1) </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restoreThreshold</span>: <span style=color:#ae81ff>2</span> <span style=color:#75715e>#(2)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>actionName</span>: <span style=color:#e6db74>&#34;disablescheduling&#34;</span> <span style=color:#75715e>#(3) </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>strategy</span>: <span style=color:#e6db74>&#34;None&#34;</span> <span style=color:#75715e>#(4) </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metricRule</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;cpu_total_usage&#34;</span> <span style=color:#75715e>#(5) </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>4000</span> <span style=color:#75715e>#(6) </span>
</span></span></code></pre></div><ol><li>We consider the rule is triggered, when the threshold reached continued so many times</li><li>We consider the rule is restored, when the threshold not reached continued so many times</li><li>Name of AvoidanceAction which be associated</li><li>Strategy for the action, you can set it &ldquo;Preview&rdquo; to not perform actually</li><li>Name of metric</li><li>Threshold of metric</li></ol><p>Please check the video to learn more about the scheduling disable actions.</p><script id=asciicast-480735 src=https://asciinema.org/a/480735.js async></script><h3 id=throttle>Throttle</h3><p>The following AvoidanceAction and NodeQOSEnsurancePolicy can be defined. As a result, when the node CPU usage triggers the threshold, throttle action for the node will be executed.</p><p>The sample YAML looks like below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AvoidanceAction</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>throttle</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>coolDownSeconds</span>: <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>throttle</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cpuThrottle</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>minCPURatio</span>: <span style=color:#ae81ff>10</span> <span style=color:#75715e>#(1)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stepCPURatio</span>: <span style=color:#ae81ff>10</span> <span style=color:#75715e>#(2) </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;throttle low priority pods&#34;</span>
</span></span></code></pre></div><ol><li>The minimal ratio of the CPU quota, if the pod is throttled lower than this ratio, it will be set to this.</li><li>The step for throttle action. It will reduce this percentage of CPU quota in each avoidance triggered.It will increase this percentage of CPU quota in each restored.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NodeQOSEnsurancePolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;waterline2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;system&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodeQualityProbe</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodeLocalGet</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>localCacheTTLSeconds</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>objectiveEnsurances</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;cpu-usage&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>avoidanceThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restoredThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>actionName</span>: <span style=color:#e6db74>&#34;throttle&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>strategy</span>: <span style=color:#e6db74>&#34;None&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>metricRule</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;cpu_total_usage&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>6000</span>
</span></span></code></pre></div><h3 id=eviction>Eviction</h3><p>The following YAML is another case, low priority pods on the node will be evicted, when the node CPU usage trigger the threshold.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AvoidanceAction</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>eviction</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>coolDownSeconds</span>: <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>eviction</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>30</span> <span style=color:#75715e>#(1) </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;evict low priority pods&#34;</span>
</span></span></code></pre></div><ol><li>Duration in seconds the pod needs to terminate gracefully.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NodeQOSEnsurancePolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;waterline3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;system&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodeQualityProbe</span>: 
</span></span><span style=display:flex><span>    <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodeLocalGet</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>localCacheTTLSeconds</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>objectiveEnsurances</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;cpu-usage&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>avoidanceThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restoreThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>actionName</span>: <span style=color:#e6db74>&#34;eviction&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>strategy</span>: <span style=color:#e6db74>&#34;Preview&#34;</span> <span style=color:#75715e>#(1) </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metricRule</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;cpu_total_usage&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>6000</span>
</span></span></code></pre></div><ol><li>Strategy for the action, &ldquo;Preview&rdquo; to not perform actually</li></ol><h3 id=supported-metrics>Supported Metrics</h3><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>cpu_total_usage</td><td>node cpu usage</td></tr><tr><td>cpu_total_utilization</td><td>node cpu utilization</td></tr></tbody></table><h3 id=accurately-perform-avoidance-actions>Accurately Perform Avoidance Actions</h3><p>Through the following two points, the excessive operation of low-quality pod can be avoided, and the gap between the metrics and the specified waterline can be reduced faster, so as to ensure that the high-priority service is not affected</p><ol><li>Sort pod</li></ol><p>Crane implements some general sorting methods (which will be improved later):</p><p>ClassAndPriority: compare the QOSClass and class value of two pods, compare QOSClass first, and then class value; Those with high priority are ranked later and have higher priority</p><p>runningTime: compare the running time of two pods. The one with long running time is ranked later and has higher priority</p><p>If you only need to use these two sorting strategies, you can use the default sorting method: you will first compare the priority of the pod, then compare the consumption of the corresponding indicators of the pod, and then compare the running time of the pod. There is a dimension that can compare the results, that is, the sorting results of the pod</p><p>Taking the ranking of CPU usage metric as an example, it also extends some ranking strategies related to its own metric, such as the ranking of CPU usage, which will compare the priority of two pods in turn. If the priority is the same, then compare the CPU consumption. If the CPU consumption is also the same, continue to compare the extended CPU resource consumption, and finally compare the running time of pod, when there is a difference in an indicator, the comparison result can be returned: <code>orderedby (classandpriority, CpuUsage, extcpuusage, runningtime) Sort(pods)</code></p><ol start=2><li>Refer to the waterline and pod usage to perform avoidance action</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//Divide all the metrics that trigger the waterline threshold into two parts according to their quantified attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>metricsQuantified</span>, <span style=color:#a6e22e>MetricsNotQuantified</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ThrottleDownWaterLine</span>.<span style=color:#a6e22e>DivideMetricsByQuantified</span>()
</span></span><span style=display:flex><span><span style=color:#75715e>// If there is a metric that cannot be quantified, obtain the metric of a throttleable with the highest actionpriority to operate on all selected pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>MetricsNotThrottleQuantified</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetHighestPriorityThrottleAbleMetric</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>throttlePods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>highestPrioriyMetric</span>)
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Get the latest usage, get the gap to waterline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span> = <span style=color:#a6e22e>buildGapToWaterLine</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>getStateFunc</span>())
</span></span><span style=display:flex><span>    <span style=color:#75715e>//If the real-time consumption of metric in the trigger waterline threshold cannot be obtained, chose the metric which is throttleable with the highest actionpriority to suppress all selected pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>.<span style=color:#a6e22e>HasUsageMissedMetric</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>highestPrioriyMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ThrottleDownWaterLine</span>.<span style=color:#a6e22e>GetHighestPriorityThrottleAbleMetric</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errPodKeys</span> = <span style=color:#a6e22e>throttlePods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>, <span style=color:#a6e22e>highestPrioriyMetric</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//Traverse the quantifiable metrics in the metrics that trigger the waterline: if the metric has a sorting method, use its sortfunc to sort the pod directly, 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//otherwise use generalsorter to sort; Then use its corresponding operation method to operate the pod, and calculate the amount of resources released from the corresponding metric until the gap between the corresponding metric and the waterline no longer exists
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>metricsQuantified</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SortAble</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SortFunc</span>(<span style=color:#a6e22e>ThrottleDownPods</span>)
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>GeneralSorter</span>(<span style=color:#a6e22e>ThrottleDownPods</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>.<span style=color:#a6e22e>TargetGapsRemoved</span>(<span style=color:#a6e22e>m</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ThrottleDownPods</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>released</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>ThrottleFunc</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>ThrottleDownPods</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalReleased</span>)
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ThrottoleDownGapToWaterLines</span>[<span style=color:#a6e22e>m</span>] <span style=color:#f92672>-=</span> <span style=color:#a6e22e>released</span>[<span style=color:#a6e22e>m</span>]
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>About extending user-defined metrics and sorting, it is introduced in &ldquo;User-defined metrics interference detection avoidance and user-defined sorting&rdquo;.</p><h2 id=enhanced-bypass-cpuset-management-capability>Enhanced bypass cpuset management capability</h2><p>Kubelet supports the static CPU manager strategy. When the guaranteed pod runs on the node, kebelet will allocate the specified dedicated CPU for the pod, which cannot be occupied by other processes. This ensures the CPU monopoly of the guaranteed pod, but also causes the low utilization of CPU and nodes, resulting in a certain waste.
Crane agent provides a new strategy for cpuset management, allowing pod and other pod to share CPU. When it specifies CPU binding core, it can make use of the advantages of less context switching and higher cache affinity of binding core, and also allow other workload to deploy and share, so as to improve resource utilization.</p><ol><li>Three types of pod cpuset are provided:</li></ol><ul><li>Exclusive: after binding the core, other containers can no longer use the CPU and monopolize the CPU</li><li>Share: other containers can use the CPU after binding the core</li><li>None: select the CPU that is not occupied by the container of exclusive pod, can use the binding core of share type</li></ul><p>Share type binding strategy can make use of the advantages of less context switching and higher cache affinity, and can also be shared by other workload deployments to improve resource utilization</p><ol start=2><li>Relax the restrictions on binding cores in kubelet</li></ol><p>Originally, it was required that the CPU limit of all containers be equal to the CPU request. Here, it is only required that the CPU limit of any container be greater than or equal to 1 and equal to the CPU request to set the binding core for the container</p><ol start=3><li>Support modifying the cpuset policy of pod during the running of pod, which will take effect immediately</li></ol><p>The CPU manager policy of pod is converted from none to share and from exclusive to share without restart</p><p>How to use:</p><ol><li>Set the cpuset manager of kubelet to &ldquo;None&rdquo;</li><li>Set CPU manager policy through pod annotation
<code>qos.gocrane.io/cpu-manager: none/exclusive/share</code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>qos.gocrane.io/cpu-manager</span>: <span style=color:#ae81ff>none/exclusive/share</span>
</span></span></code></pre></div></li></ol><h2 id=dynamic-resource-oversold-enhanced-by-prediction-algorithm>Dynamic resource oversold enhanced by prediction algorithm</h2><p>In order to improve the stability, users usually set the request value higher than the actual usage when deploying applications, resulting in a waste of resources. In order to improve the resource utilization of nodes, users will deploy some besteffort applications in combination, using idle resources to realize oversold;
However, due to the lack of resource limit and request constraints and related information in these applications, scheduler may still schedule these pods to nodes with high load, which is inconsistent with our original intention, so it is best to schedule based on the free resources of nodes.</p><p>Crane collects the idle resources of nodes in the following two ways, and takes them as the idle resources of nodes after synthesis, which enhances the accuracy of resource evaluation:</p><ol><li>CPU usage information collected locally</li></ol><p><code>nodeCpuCannotBeReclaimed := nodeCpuUsageTotal + exclusiveCPUIdle - extResContainerCpuUsageTotal</code></p><p>ExclusiveCPUIdle refers to the idle amount of CPU occupied by the pod whose CPU manager policy is exclusive. Although this part of resources is idle, it cannot be reused because of monopoly, so it is counted as used</p><p>ExtResContainerCpuUsageTotal refers to the CPU consumption used as dynamic resources, which needs to be subtracted to avoid secondary calculation</p><ol start=2><li>Create a TSP of node CPU usage, which is automatically created by default, and will predict node CPU usage based on history</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>spec</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    predictionMetrics:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - algorithm:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        algorithmType: dsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        dsp:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          estimators:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            fft:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - highFrequencyThreshold: &#34;0.05&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              lowAmplitudeThreshold: &#34;1.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              marginFraction: &#34;0.2&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              maxNumOfSpectrumItems: 20
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              minNumOfSpectrumItems: 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          historyLength: 3d
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          sampleInterval: 60s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      resourceIdentifier: cpu
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      type: ExpressionQuery
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      expressionQuery:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        expression: &#39;sum(count(node_cpu_seconds_total{mode=&#34;idle&#34;,instance=~&#34;({{.metadata.name}})(:\\d+)?&#34;}) by (mode, cpu)) - sum(irate(node_cpu_seconds_total{mode=&#34;idle&#34;,instance=~&#34;({{.metadata.name}})(:\\d+)?&#34;}[5m]))&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    predictionWindowSeconds: 3600</span>    
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>noderesource-tsp-template</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span></code></pre></div><p>Combine the prediction algorithm with the current actual consumption to calculate the remaining available resources of the node, and give it to the node as an extended resource. Pod can indicate that the extended resource is used as an offline job to use the idle resources, so as to improve the resource utilization rate of the node;</p><p>How to use:
When deploying pod, limit and request use <code>gocrane.io/&lt;$resourcename>:&lt;$value></code>, as follows</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>: 
</span></span><span style=display:flex><span>   <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>   - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>name</span>: <span style=color:#ae81ff>extended-resource-demo-ctr</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>         <span style=color:#f92672>gocrane.io/cpu</span>: <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>         <span style=color:#f92672>gocrane.io/cpu</span>: <span style=color:#e6db74>&#34;2&#34;</span>
</span></span></code></pre></div><h2 id=elastic-resource-restriction-function>Elastic resource restriction function</h2><p>The native besteffort application lacks a fair guarantee of resource usage. Crane guarantees that the CPU usage of the besteffort pod using dynamic resources is limited within the reasonable range of its allowable use. The agent guarantees that the actual consumption of the pod using extended resources will not exceed its stated limit. At the same time, when the CPU competes, it can also compete fairly according to its stated amount; At the same time, pod using elastic resources will also be managed by the waterline function.</p><p>How to use:
When deploying pod, limit and request use <code>gocrane.io/&lt;$resourcename>:&lt;$value></code></p><h2 id=user-defined-metrics-interference-detection-avoidance-and-user-defined-sorting>User-defined metrics interference detection avoidance and user-defined sorting</h2><p>The use of user-defined metrics interference detection avoidance and user-defined sorting is the same as the process described in the &ldquo;Accurately Perform Avoidance Actions&rdquo;. Here is how to customize your own metrics to participate in the interference detection avoidance process</p><p>In order to better sort and accurately control metrics configured based on NodeQoSEnsurancePolicy, the concept of attributes is introduced into metrics.</p><p>The attributes of metric include the following, and these fields can be realized by customized indicators:</p><ol><li>Name Indicates the name of metric, which should be consistent with the metric name collected in the collector module</li><li>ActionPriority Indicates the priority of the metric. 0 is the lowest and 10 is the highest</li><li>SortAble Indicates whether the metric can be sorted. If it is true, the corresponding SortFunc needs to be implemented</li><li>SortFunc The corresponding sorting method. The sorting method can be arranged and combined with some general methods, and then combined with the sorting of the metric itself, which will be introduced in detail below</li><li>ThrottleAble Indicates whether pod can be suppressed for this metric. For example, for the metric of CPU usage, there are corresponding suppression methods, but for the metric of memory usage, pod can only be evicted, and effective suppression cannot be carried out</li><li>ThrottleQuantified Indicates whether the amount of resources corresponding to metric released after suppressing (restoring) a pod can be accurately calculated. We call the metric that can be accurately quantified as quantifiable, otherwise it is not quantifiable;
For example, the CPU usage can be suppressed by limiting the CGroup usage, and the CPU usage released after suppression can be calculated by the current running value and the value after suppression; Memory usage does not belong to suppression quantifiable metric, because memory has no corresponding throttle implementation, so it is impossible to accurately measure the specific amount of memory resources released after suppressing a pod;</li><li>ThrottleFunc The specific method of executing throttle action. If throttle is not available, the returned released is null</li><li>RestoreFunc After being throttled, the specific method of performing the recovery action. If restore is not allowed, the returned released is null</li><li>Evictable, EvictQuantified and EvictFunc The relevant definitions of evict action are similar to those of throttle action</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>metric</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span> <span style=color:#a6e22e>WaterLineMetric</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ActionPriority</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SortAble</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SortFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#a6e22e>podinfo</span>.<span style=color:#a6e22e>PodContext</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ThrottleAble</span>      <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ThrottleQuantified</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ThrottleFunc</span>      <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecuteContext</span>, <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ThrottleDownPods</span> <span style=color:#a6e22e>ThrottlePods</span>, <span style=color:#a6e22e>totalReleasedResource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReleaseResource</span>) (<span style=color:#a6e22e>errPodKeys</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RestoreFunc</span>       <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecuteContext</span>, <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ThrottleUpPods</span> <span style=color:#a6e22e>ThrottlePods</span>, <span style=color:#a6e22e>totalReleasedResource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReleaseResource</span>) (<span style=color:#a6e22e>errPodKeys</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EvictAble</span>      <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EvictQuantified</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EvictFunc</span>      <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExecuteContext</span>, <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>totalReleasedResource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReleaseResource</span>, <span style=color:#a6e22e>EvictPods</span> <span style=color:#a6e22e>EvictPods</span>) (<span style=color:#a6e22e>errPodKeys</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>released</span> <span style=color:#a6e22e>ReleaseResource</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After the construction is completed, register the metric through registerMetricMap()</p><p>For the metrics that need to be customized, you can easily realize the flexible customized sorting of pod by combining the following methods with general sorting methods to represent the customized metric indicators, <metric-sort-func>represents the customized sorting strategy</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>func &lt;metric&gt;Sorter(pods []podinfo.PodContext) {</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>orderedBy(classAndPriority, &lt;metric-sort-func&gt;, runningTime).Sort(pods)</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Among them, the following sorting method <code>&lt;metric-sort-func></code> needs to be implemented
<code>func (p1, p2 podinfo.PodContext) int32</code></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/gocrane/shared_invite/zt-1ehm9871y-Zgs5pXxSIhYg5hGSc5XZgQ aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Community Meetings" aria-label="Community Meetings"><a class=text-white target=_blank rel=noopener href=https://www.wolai.com/33xC4HB1JXCCH1x8umfioS aria-label="Community Meetings"><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/gocrane/crane aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/gocrane/shared_invite/zt-1ehm9871y-Zgs5pXxSIhYg5hGSc5XZgQ aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Community Meetings" aria-label="Community Meetings"><a class=text-white target=_blank rel=noopener href=https://www.wolai.com/33xC4HB1JXCCH1x8umfioS aria-label="Community Meetings"><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Crane Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/main-docsy/js/main.min.780da35d51262201dbdab6376e49da7e3951a292d004e80aa25302ba49e27b5d.js integrity="sha256-eA2jXVEmIgHb2rY3bknafjlRopLQBOgKolMCuknie10=" crossorigin=anonymous></script></body></html>